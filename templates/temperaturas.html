{% extends "base.html" %}

{% block title %}Datos Meteorológicos{% endblock %}

{% block page_title %}{{ titulo if titulo else "Panel de Datos Meteorológicos" }}{% endblock %}

{% block page_description %}
    {{ descripcion if descripcion else "Visualización interactiva de datos históricos y actuales de las estaciones meteorológicas." }}
{% endblock %}

{% block head_extra %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        .card-metric .card-body {
            text-align: center;
        }
        .card-metric .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .card-metric .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .filter-section .form-select, .filter-section .btn {
            margin-bottom: 10px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <h1 class="page-title display-6">{{ titulo if titulo else "Panel de Datos Meteorológicos" }}</h1>
    <p class="lead">
        {{ descripcion if descripcion else "Visualización interactiva de datos históricos y actuales de las estaciones meteorológicas." }}
    </p>
    <p><strong>Estado del Sistema:</strong> <span class="badge {% if estado_sistema == 'Activo' %}bg-success{% elif estado_sistema == 'Error' or 'Inactivo' in estado_sistema %}bg-danger{% else %}bg-warning{% endif %}">{{ estado_sistema }}</span></p>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card card-metric shadow-sm">
            <div class="card-body">
                <div class="metric-value">{{ datos_tarjetas.numero_estaciones if datos_tarjetas else 'N/A' }}</div>
                <div class="metric-label">Estaciones Monitoreadas</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-metric shadow-sm">
            <div class="card-body">
                <div class="metric-value">{{ datos_tarjetas.promedio_temperatura if datos_tarjetas else 'N/A' }}</div>
                <div class="metric-label">Temperatura Promedio</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-metric shadow-sm">
            <div class="card-body">
                <div class="metric-value">{{ datos_tarjetas.max_humedad if datos_tarjetas else 'N/A' }}</div>
                <div class="metric-label">Humedad Máx. Registrada</div>
            </div>
        </div>
    </div>
    </div>

<div class="card shadow-sm mb-4 filter-section">
    <div class="card-header">
        <h5 class="card-title mb-0">Filtros de Visualización</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label for="selectDate" class="form-label">Fecha:</label>
                <select id="selectDate" class="form-select">
                    <option value="">Todas las Fechas</option>
                    {% for date in select_dates %}
                    <option value="{{ date }}">{{ date }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="selectStation" class="form-label">Estación Meteorológica:</label>
                <select id="selectStation" class="form-select">
                    <option value="">Todas las Estaciones</option>
                    {% for station in select_stations %}
                    <option value="{{ station }}">{{ station }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="selectMetric" class="form-label">Métrica para Gráfico:</label>
                <select id="selectMetric" class="form-select">
                    {% for metric in select_metrics %}
                    <option value="{{ metric.key }}">{{ metric.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button id="applyFiltersBtn" class="btn btn-primary w-100">Aplicar Filtros y Actualizar Gráfico</button>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Gráfico de Tendencias Meteorológicas</h5>
    </div>
    <div class="card-body">
        <div id="weatherChartContainer" style="height: 400px;">
            <p class="text-center text-muted">Seleccione filtros y haga clic en "Aplicar" para generar el gráfico.</p>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header">
        <h5 class="card-title mb-0">Registros Detallados de Datos Meteorológicos</h5>
    </div>
    <div class="card-body">
        <table id="temperaturaDataTable" class="table table-striped table-bordered" style="width:100%">
            <thead>
                <tr>
                    <th>Nombre Estación</th>
                    <th>Dirección</th>
                    <th>Timestamp Captura</th>
                    <th>Temperatura</th>
                    <th>Humedad Rel.</th>
                    <th>Vel. Viento</th>
                    <th>Dir. Viento</th>
                    <th>Presión Bar.</th>
                    <th>Precipitación</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
            <tfoot>
                <tr>
                    <th>Nombre Estación</th>
                    <th>Dirección</th>
                    <th>Timestamp Captura</th>
                    <th>Temperatura</th>
                    <th>Humedad Rel.</th>
                    <th>Vel. Viento</th>
                    <th>Dir. Viento</th>
                    <th>Presión Bar.</th>
                    <th>Precipitación</th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
    $(document).ready(function() {
        // Inicialización de DataTables
        var table = $('#temperaturaDataTable').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": {
                "url": "/api/datos_temperatura", // Endpoint que sirve los datos desde procesar_para_datatable_temperatura
                "type": "POST", // O GET, según cómo esté configurado tu backend
                "dataType": "json",
                "contentType": "application/json",
                "data": function (d) {
                    // Si tu backend espera JSON, convierte los datos de DataTables
                    // console.log("Enviando a DataTables:", JSON.stringify(d));
                    return JSON.stringify(d);
                },
                "error": function(xhr, error, thrown) {
                    console.error("Error en DataTables AJAX: ", xhr.responseText);
                    alert("Error al cargar datos para la tabla. Por favor, revise la consola del navegador.");
                }
            },
            "columns": [
                // Estas definiciones deben coincidir con el orden de `COLUMN_MAP_TEMP`
                // y cómo se estructura `data_output` en `procesar_para_datatable_temperatura`
                { "data": 0, "name": "nombre", "title": "Nombre Estación" },
                { "data": 1, "name": "direccion", "title": "Dirección" },
                { "data": 2, "name": "timestamp_captura_original", "title": "Timestamp Captura" },
                { "data": 3, "name": "temperatur", "title": "Temperatura" },
                { "data": 4, "name": "humedad_re", "title": "Humedad Rel." },
                { "data": 5, "name": "viento_vel", "title": "Vel. Viento" },
                { "data": 6, "name": "viento_dir", "title": "Dir. Viento" },
                { "data": 7, "name": "presion_ba", "title": "Presión Bar." },
                { "data": 8, "name": "precipitac", "title": "Precipitación" }
            ],
            "responsive": true,
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json" // Para traducción al español
            },
            "order": [[2, 'desc']], // Ordenar por timestamp_captura por defecto (columna índice 2)
            "initComplete": function(settings, json) {
                console.log("DataTables inicializado.");
                // Puedes añadir aquí inputs de búsqueda por columna en el tfoot si lo deseas
            }
        });

        // Lógica para filtros y actualización de gráficos (Placeholder)
        $('#applyFiltersBtn').on('click', function() {
            var selectedDate = $('#selectDate').val();
            var selectedStation = $('#selectStation').val();
            var selectedMetric = $('#selectMetric').val();

            console.log("Filtros aplicados:");
            console.log("Fecha: ", selectedDate);
            console.log("Estación: ", selectedStation);
            console.log("Métrica: ", selectedMetric);
            
            // Aquí iría la lógica para recargar o actualizar el gráfico
            // Por ejemplo, hacer una llamada AJAX para obtener datos filtrados para el gráfico
            // y luego actualizar el Chart.js (o la librería que uses)
            $('#weatherChartContainer').html('<p class="text-center text-info">Cargando datos del gráfico...</p>');
            // Simulación de carga de gráfico
            setTimeout(function() {
                // Debes obtener `raw_weather_data_for_graphs` de alguna forma
                // o hacer un fetch a un endpoint que devuelva los datos para el gráfico
                // basados en los filtros.
                // const allDataForGraph = {{ raw_weather_data_for_graphs|tojson|safe }};
                // const filteredGraphData = filterDataForGraph(allDataForGraph, selectedDate, selectedStation, selectedMetric);
                // renderWeatherChart(filteredGraphData, selectedMetric);
                 $('#weatherChartContainer').html('<p class="text-center text-success">Gráfico actualizado (simulación). Implementa la lógica de graficación aquí.</p>');
            }, 1500);
        });

        // Función para renderizar el gráfico (Ejemplo con Chart.js - necesitarías implementarla)
        /*
        let weatherChartInstance = null;
        function renderWeatherChart(data, metricKey) {
            const ctx = document.getElementById('weatherChartContainerCanvas'); // Necesitarías un <canvas id="weatherChartContainerCanvas"></canvas>
            if (!ctx) {
                 $('#weatherChartContainer').html('<canvas id="weatherChartContainerCanvas" style="height: 400px;"></canvas>');
            }
            const chartCtx = document.getElementById('weatherChartContainerCanvas').getContext('2d');


            const labels = data.map(item => item.time_str || item.timestamp_captura_original); // o item.date_str
            const values = data.map(item => item[metricKey]);
            const metricConfig = {{ select_metrics|tojson|safe }}.find(m => m.key === metricKey);
            const metricName = metricConfig ? metricConfig.name : metricKey;

            if (weatherChartInstance) {
                weatherChartInstance.destroy();
            }

            weatherChartInstance = new Chart(chartCtx, {
                type: 'line', // o 'bar', etc.
                data: {
                    labels: labels,
                    datasets: [{
                        label: metricName,
                        data: values,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false // Ajustar según la métrica
                        }
                    }
                }
            });
        }
        */
        // Función para filtrar datos para el gráfico (necesitaría acceso a los datos completos)
        // function filterDataForGraph(allData, date, station, metric) { ... }

    });
    </script>
{% endblock %}